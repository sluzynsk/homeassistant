<dom-module id='ha-panel-tasmota'>
    <template>
        <style include="ha-style">
            .tappable {
                cursor: pointer;
            }
            .content {
                padding: 24px;
            }
            .title {
                @apply(--paper-font-headline);
            }
        </style>    

        <app-header-layout has-scrolling-region>
            <app-header slot="header" fixed>
                <app-toolbar>
                    <ha-menu-button hass='[[hass]]' narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
                    <div main-title>Tasmota Device Management</div>
                </app-toolbar>
            </app-header>

            <div class='content'>
                <div class="mdc-data-table">
                <table class="mdc-data-table__table">
                    <thead>
                        <tr class="mdc-data-table__header-row">
                            <th class=mdc-data-table__header-cell role="columnheader" scope="col"></th>
                            <th class=mdc-data-table__header-cell role="columnheader" scope="col">Entity ID</th>
                            <th class=mdc-data-table__header-cell role="columnheader" scope="col">Friendly Name</th>
                            <th class=mdc-data-table__header-cell role="columnheader" scope="col">IP Address</th>
                            <th class=mdc-data-table__header-cell role="columnheader" scope="col">Version</th>
                        </tr>
                    </thead>
                    <tbody class="mdc-data-table__content">
                        <template is="dom-repeat" items='[[devices]]' as='entity'>
                            <tr class="mdc-data-table__row">
                            <div class="tappable" on-tap='entityTapped' data-entity$='[[entity.entity_id]]'>
                                <td class="mdc-data-table__cell"><paper-checkbox hass='[[hass]]'></paper-checkbox></td>
                                <td class="mdc-data-table__cell">[[entity.entity_id]]</td>
                                <td class="mdc-data-table__cell">[[entity.attributes.friendly_name]]</td>
                                <td class="mdc-data-table__cell">[[entity.attributes.IPAddress]]</td>
                                <td class="mdc-data-table__cell">[[entity.attributes.Version]]</td>
                            </div>
                        </tr>
                        </template> 
                    </tbody>
                </table>
                </div>
                <mwc-button hass='[[hass]]' raised=>Update checked</mwc-button>
            </div>
        </app-header-layout>
    </template>
</dom-module>

<script>  
Polymer({
    is:  'ha-panel-tasmota',

    properties: {   
        hass:     { type: Object },
        panel:    { type: Object },
        narrow:   { type: Boolean, value: false },
        showMenu: { type: Boolean, value: false },
        devices:  { type: Array, computed: 'computeDevices(hass)' },
    },

    observers: [ 'onPanelUpdate(hass, panel)' ],

    computeDevices: function(hass) {
        let states = new Array();
        let sensors = new Array();
        let item = new Object();

        for (item in hass.states)
        {   
            if (item.indexOf("sensor.") != 0)
                continue;
            if (typeof(hass.states[item].attributes.Version) === "undefined")
                continue;
            states.push(hass.states[item]); 
        }   
        return states;
    },

    entityTapped: function(ev) {
        ev.stopPropagation();
        var entityId = ev.target.getAttribute('data-entity');
        this.fire('hass-more-info', { entityId: entityId });
    },

    onPanelUpdate: function(hass, panel) {
        this.devices = this.computeDevices(hass);
    }

});
     
</script>
